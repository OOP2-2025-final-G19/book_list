<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>読了済みリスト</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='base-style.css') }}">
</head>

<body>
    <h1>{{ title }}</h1>

    <ul class="breadcrumb">
        <li><a href="{{ url_for('index') }}">HOME</a></li>
        <li><a href="{{ url_for('registration.read_list') }}">読了済みリスト</a></li>
    </ul>

    <a href="{{ url_for('registration.add') }}">新規書籍追加</a>
    <table>
        <thead>
            <tr>
                <th>
                    <a href="{{ url_for(
                        'registration.read_list',
                        sort='title',
                        order='asc' if sort == 'title' and order == 'desc' else 'desc'
                    ) }}">
                        タイトル
                        {% if sort == 'title' %}
                        {{ '▲' if order == 'asc' else '▼' }}
                        {% endif %}
                    </a>
                </th>
                <th>
                    <a href="{{ url_for(
                        'registration.read_list',
                        sort='author',
                        order='asc' if sort == 'author' and order == 'desc' else 'desc'
                    ) }}">
                        著者
                        {% if sort == 'author' %}
                        {{ '▲' if order == 'asc' else '▼' }}
                        {% endif %}
                    </a>
                </th>
                <th>
                    <a href="{{ url_for(
                        'registration.read_list',
                        sort='day',
                        order='asc' if sort == 'day' and order == 'desc' else 'desc'
                    ) }}">
                        登録日
                        {% if sort == 'day' %}
                        {{ '▲' if order == 'asc' else '▼' }}
                        {% endif %}
                    </a>
                </th>
                <th>
                    <a href="{{ url_for(
                        'registration.read_list',
                        sort='review',
                        order='asc' if sort == 'review' and order == 'desc' else 'desc'
                    ) }}">
                        評価
                        {% if sort == 'review' %}
                        {{ '▲' if order == 'asc' else '▼' }}
                        {% endif %}
                    </a>
                </th>
                <th>備考</th>
            </tr>
        </thead>

        <tbody>
            {% for book in items %}
            <tr>
                <td ondblclick="editCell(this, {{ book.id }}, 'title')">{{ book.title }}</td>
                <td ondblclick="editCell(this, {{ book.id }}, 'author')">{{ book.author }}</td>
                <td>{{ book.day.strftime('%Y/%m/%d') }}</td>
                <td ondblclick="editCell(this, {{ book.id }}, 'review')">{{ book.review }}</td>
                <td ondblclick="editCell(this, {{ book.id }}, 'thoughts')">{{ book.thoughts }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</body>

</html>

<script>
    function editCell(td, bookId, field) {
        const currentValue = td.innerText;

        const input = document.createElement("input");

        input.type = "text";
        input.value = currentValue;
        td.innerHTML = "";
        td.appendChild(input);
        input.focus();

        input.onblur = () => {
            const value = input.value.trim();

            // 空欄チェック（共通）
            if (value === "") {
                alert("空欄にはできません");
                td.innerText = currentValue;
                return;
            }

            // 評価の範囲チェック
            if (field === "review") {
                const num = Number(value);
                if (isNaN(num) || num < 0 || num > 5) {
                    alert("評価は0〜5の範囲で入力してください");
                    td.innerText = currentValue;
                    return;
                }
            }

            fetch(`/books/update/${bookId}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    field: field,
                    value: value
                })
            }).then(res => {
                if (!res.ok) {
                    alert("更新に失敗しました");
                    td.innerText = currentValue;
                    return;
                }
                td.innerText = value;
            });
        };
    }
</script>